name: Terraform + Ansible Docker Setup

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3

    - name: â˜ï¸ Set up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: ğŸ—ï¸ Create GCP Credentials File
      run: echo "${{ secrets.GOOGLE_CREDENTIALS }}" > terraform/gcp-key.json

    - name: ğŸ“¦ Terraform Init and Apply
      working-directory: terraform
      run: |
        terraform init
        terraform apply -auto-approve

    - name: ğŸŒ Get VM IP from Terraform Output
      id: get_ip
      working-directory: terraform
      run: |
        echo "vm_ip=$(terraform output -raw vm_ip)" >> $GITHUB_ENV

    - name: ğŸ› ï¸ Install Ansible
      run: sudo apt-get update && sudo apt-get install -y ansible

    - name: ğŸ” Add SSH Private Key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: ğŸ“ Create Ansible Inventory File
      run: |
        echo "[ubuntu]" > ansible/inventory.ini
        echo "$VM_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa" >> ansible/inventory.ini
      env:
        VM_IP: ${{ env.vm_ip }}

    - name: ğŸ³ Run Ansible to Install Docker
      run: ansible-playbook -i ansible/inventory.ini ansible/install_docker.yml
